#!/usr/bin/env bash
set -e

function usage() {
  cat <<EOF
USAGE:
  $(basename $0) [OPTION] <dir>

OPTIONS:
  --absolute                Provide the absolute path.
  --basename                Provide the filename from a path.
  --dirname                 Provide the dirname from a path.
  --scm-root                Find the scm root (git or hg).
  --help                    This help.

EOF
  exit 0
}

function find_path_in_arguments() {
  for arg in "$@"; do
    if ! [[ ${arg} =~ ^- ]]; then
      [[ ! -z ${path} ]] && fatal "Only one path should be parsed in."
      path=${arg}
    fi
  done

  [[ -z ${path} ]] && path=$(pwd)
  [[ ! -e ${path} ]] && fatal "Invalid path"

  echo ${path}
}

function __dirname() {
  [[ ! -d $1 ]] && dir=$(dirname $1) || dir=$1
  cd ${dir}
  dir=$(pwd)
  [[ ! ${dir} =~ /$ ]] && dir="${dir}/"
  echo ${dir} | sed 's#//#/#g'        # compress // down to /
}

function __filename() {
  [[ -d $1 ]] && return 1
  echo $(basename $1)
}

function __root_dir() {
  [[ $(__dirname ${dir}) == "/" ]]
  return $?
}

function __git_dir() {
  [[ -d "$1/.git" ]]
  return $?
}

function __hg_dir() {
  [[ -d "$1/.hg" ]]
  return $?
}

function __scm_dir() {
  __git_dir $1 || __hg_dir $1
  return $?
}

function scm_root() {
  dir=$1
  while ! __root_dir ${dir} && ! __git_dir ${dir} && ! __hg_dir; do
    dir=$(__dirname ${dir}/../)
  done

  [[ ${dir} == "/" ]] && fatal "SCM dir not found"
  echo ${dir}
}

function debug() {
  echo "PATH_ARG:${PATH_ARG}"
  echo "DIR:${DIR}"
  echo "FILE:${FILE}"
  echo "FLAT_PATH:${FLAT_PATH}"
  exit 0
}

function error() {
  echo "Error: $1" > /dev/stderr
  return 1
}

function fatal() {
  echo "Fatal: $1" > /dev/stderr
  exit 1
}

PATH_ARG=$(find_path_in_arguments $@)
DIR=$(__dirname ${PATH_ARG})
FILE=$(__filename ${PATH_ARG}; true)
FLAT_PATH="${DIR}${FILE}"

for arg in "$@"; do
  case "${arg}" in
    "--absolute")                 echo ${FLAT_PATH}                              ;;
    "--basename")                 __filename ${PATH_ARG} || error "Path isn't to a file" ;;
    "--debug")                    debug                                     ;;
    "--dirname")                  echo ${DIR}                               ;;
    "--scm-root")                 scm_root ${DIR}                           ;;
    "--help")                     usage                                     ;;
  esac
done

exit $?
